generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["common", "manual", "business", "influencer", "inventory"]
}

// ==================== COMMON SCHEMA ====================

model audit_logs {
  id          Int      @id @default(autoincrement())
  user_id     String?
  action      String
  entity_type String
  entity_id   Int?
  detail      Json?
  created_at  DateTime @default(now())
  users       users?   @relation(fields: [user_id], references: [id])

  @@schema("common")
}

model company_settings {
  id                Int      @id @default(autoincrement())
  name              String
  business_number   String?
  representative    String?
  address           String?
  phone             String?
  fax               String?
  email             String?
  business_type     String?
  business_category String?
  created_at        DateTime @default(now())
  updated_at        DateTime

  @@schema("common")
}

model roles {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  users       users[]

  @@schema("common")
}

model users {
  id         String       @id
  email      String       @unique
  name       String
  role_id    Int?
  created_at DateTime     @default(now())
  audit_logs audit_logs[]
  roles      roles?       @relation(fields: [role_id], references: [id])

  @@schema("common")
}

// ==================== MANUAL SCHEMA ====================

model manual_categories {
  id          Int                 @id @default(autoincrement())
  name        String
  description String?
  parent_id   Int?
  order       Int                 @default(0)
  created_at  DateTime            @default(now())
  updated_at  DateTime            @updatedAt
  parent      manual_categories?  @relation("ManualCategoryHierarchy", fields: [parent_id], references: [id])
  children    manual_categories[] @relation("ManualCategoryHierarchy")
  manuals     manuals[]

  @@schema("manual")
}

model manuals {
  id              Int                  @id @default(autoincrement())
  title           String
  content         String
  summary         String?
  category_id     Int?
  status          ManualStatus         @default(DRAFT)
  version         Int                  @default(1)
  view_count      Int                  @default(0)
  created_by      String?
  updated_by      String?
  created_at      DateTime             @default(now())
  updated_at      DateTime             @updatedAt
  attachments     manual_attachments[]
  chunks          manual_chunks[]
  embedding       manual_embeddings?
  versions        manual_versions[]
  category        manual_categories?   @relation(fields: [category_id], references: [id])
  procedure_links procedure_manuals[]
  tags            manual_tags[]        @relation("manual_tagsTomanuals")

  @@index([category_id])
  @@index([status])
  @@schema("manual")
}

model manual_versions {
  id          Int      @id @default(autoincrement())
  manual_id   Int
  title       String
  content     String
  version     Int
  changed_by  String?
  change_note String?
  created_at  DateTime @default(now())
  manual      manuals  @relation(fields: [manual_id], references: [id], onDelete: Cascade)

  @@index([manual_id])
  @@schema("manual")
}

model manual_tags {
  id      Int       @id @default(autoincrement())
  name    String    @unique
  manuals manuals[] @relation("manual_tagsTomanuals")

  @@schema("manual")
}

model manual_attachments {
  id         Int      @id @default(autoincrement())
  manual_id  Int
  file_name  String
  file_url   String
  file_size  Int?
  mime_type  String?
  created_at DateTime @default(now())
  manual     manuals  @relation(fields: [manual_id], references: [id], onDelete: Cascade)

  @@index([manual_id])
  @@schema("manual")
}

model manual_embeddings {
  id               Int                   @id @default(autoincrement())
  manual_id        Int                   @unique
  embedding        Bytes
  embedding_vector Unsupported("vector")
  content_hash     String
  created_at       DateTime              @default(now())
  updated_at       DateTime              @updatedAt
  manual           manuals               @relation(fields: [manual_id], references: [id], onDelete: Cascade)

  @@schema("manual")
}

model manual_chunks {
  id               Int                   @id @default(autoincrement())
  manual_id        Int
  chunk_index      Int
  content          String
  section_title    String?
  start_offset     Int
  end_offset       Int
  token_count      Int
  content_hash     String
  embedding        Bytes
  embedding_vector Unsupported("vector")
  created_at       DateTime              @default(now())
  updated_at       DateTime              @updatedAt
  manual           manuals               @relation(fields: [manual_id], references: [id], onDelete: Cascade)

  @@unique([manual_id, chunk_index])
  @@index([manual_id])
  @@index([content_hash])
  @@schema("manual")
}

model ai_chat_sessions {
  id         Int      @id @default(autoincrement())
  title      String?
  messages   Json
  context    Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@schema("manual")
}

// ==================== BUSINESS SCHEMA ====================

model procedures {
  id                  Int                             @id @default(autoincrement())
  name                String
  name_en             String?
  category            String
  subcategory         String?
  description         String?
  duration_minutes    Int
  buffer_minutes      Int                             @default(10)
  base_cost           Decimal                         @db.Decimal(12, 2)
  is_active           Boolean                         @default(true)
  requires_doctor     Boolean                         @default(true)
  created_at          DateTime                        @default(now())
  updated_at          DateTime                        @updatedAt
  influencer_supports influencer_procedure_supports[]
  cost_components     procedure_costs[]
  required_equipment  procedure_equipment[]
  required_items      procedure_items[]
  manual_links        procedure_manuals[]

  @@index([category])
  @@index([is_active])
  @@schema("business")
}

model procedure_costs {
  id           Int        @id @default(autoincrement())
  procedure_id Int
  cost_type    CostType
  name         String
  amount       Decimal    @db.Decimal(12, 2)
  unit         String?
  calculation  String?
  created_at   DateTime   @default(now())
  updated_at   DateTime   @updatedAt
  procedure    procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)

  @@index([procedure_id])
  @@schema("business")
}

model procedure_equipment {
  id             Int        @id @default(autoincrement())
  procedure_id   Int
  equipment_name String
  usage_minutes  Int?
  procedure      procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)

  @@index([procedure_id])
  @@schema("business")
}

model procedure_manuals {
  id            Int        @id @default(autoincrement())
  procedure_id  Int
  manual_id     Int
  relation_type String
  manual        manuals    @relation(fields: [manual_id], references: [id], onDelete: Cascade)
  procedure     procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)

  @@unique([procedure_id, manual_id])
  @@schema("business")
}

model procedure_items {
  id           Int        @id @default(autoincrement())
  procedure_id Int
  item_id      Int
  quantity     Decimal    @db.Decimal(10, 4)
  unit         String
  is_optional  Boolean    @default(false)
  item         items      @relation(fields: [item_id], references: [id])
  procedure    procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)

  @@unique([procedure_id, item_id])
  @@schema("business")
}

// ==================== INVENTORY SCHEMA ====================

model items {
  id                     Int               @id @default(autoincrement())
  name                   String
  category               String
  subcategory            String?
  brand                  String?
  model                  String?
  unit                   String?
  storage_condition      String?
  description            String?
  image_url              String?
  created_at             DateTime          @default(now())
  updated_at             DateTime
  distributor            String?
  manufacturer           String?
  brand_en               String?
  category_en            String?
  distributor_en         String?
  manufacturer_en        String?
  name_en                String?
  subcategory_en         String?
  order_contact_name     String?
  order_contact_phone    String?
  order_login_id         String?
  order_login_pw         String?
  order_method           String?
  order_website          String?
  usage_manual           String?
  aliases                Json?
  accessories            Json?
  packaging_desc         String?
  total_volume           Float?
  unit_type              String?
  unit_volume            Float?
  unit_volume_unit       String?
  units_per_box          Int?
  boxes_per_carton       Int?
  order_contact_id       Int?
  needs_order            Boolean?          @default(false)
  default_in_location_id Int?
  default_out_location_id Int?
  min_stock              Int?
  procedure_items        procedure_items[]

  @@schema("inventory")
}

// ==================== INFLUENCER SCHEMA ====================

model influencers {
  id               Int                             @id @default(autoincrement())
  name             String
  nickname         String?
  email            String?
  phone            String?
  instagram_handle String?
  youtube_channel  String?
  tiktok_handle    String?
  blog_url         String?
  current_tier     InfluencerTier                  @default(C)
  tier_score       Decimal?                        @db.Decimal(5, 2)
  last_analyzed_at DateTime?
  total_visits     Int                             @default(0)
  total_supported  Decimal                         @default(0) @db.Decimal(12, 2)
  notes            String?
  is_active        Boolean                         @default(true)
  is_blacklisted   Boolean                         @default(false)
  blacklist_reason String?
  created_at       DateTime                        @default(now())
  updated_at       DateTime                        @updatedAt
  analyses         influencer_analyses[]
  supports         influencer_procedure_supports[]
  visits           influencer_visits[]

  @@index([current_tier])
  @@index([is_active])
  @@schema("influencer")
}

model influencer_analyses {
  id                      Int            @id @default(autoincrement())
  influencer_id           Int
  instagram_followers     Int?
  instagram_engagement    Decimal?       @db.Decimal(5, 2)
  youtube_subscribers     Int?
  youtube_avg_views       Int?
  tiktok_followers        Int?
  tiktok_engagement       Decimal?       @db.Decimal(5, 2)
  calculated_tier         InfluencerTier
  tier_score              Decimal        @db.Decimal(5, 2)
  analysis_summary        String?
  analysis_raw            Json?
  recommended_support_min Decimal?       @db.Decimal(12, 2)
  recommended_support_max Decimal?       @db.Decimal(12, 2)
  analyzed_at             DateTime       @default(now())
  influencer              influencers    @relation(fields: [influencer_id], references: [id], onDelete: Cascade)

  @@index([influencer_id])
  @@index([analyzed_at])
  @@schema("influencer")
}

model influencer_procedure_supports {
  id               Int                @id @default(autoincrement())
  influencer_id    Int
  procedure_id     Int
  visit_id         Int?
  procedure_cost   Decimal            @db.Decimal(12, 2)
  supported_amount Decimal            @db.Decimal(12, 2)
  client_payment   Decimal            @db.Decimal(12, 2)
  status           SupportStatus      @default(SCHEDULED)
  scheduled_at     DateTime?
  completed_at     DateTime?
  notes            String?
  created_at       DateTime           @default(now())
  updated_at       DateTime           @updatedAt
  influencer       influencers        @relation(fields: [influencer_id], references: [id], onDelete: Cascade)
  procedure        procedures         @relation(fields: [procedure_id], references: [id])
  visit            influencer_visits? @relation(fields: [visit_id], references: [id])

  @@index([influencer_id])
  @@index([procedure_id])
  @@index([status])
  @@schema("influencer")
}

model influencer_visits {
  id             Int                             @id @default(autoincrement())
  influencer_id  Int
  visit_date     DateTime
  purpose        String?
  content_posted Boolean                         @default(false)
  content_urls   Json?
  notes          String?
  created_at     DateTime                        @default(now())
  updated_at     DateTime                        @updatedAt
  supports       influencer_procedure_supports[]
  influencer     influencers                     @relation(fields: [influencer_id], references: [id], onDelete: Cascade)

  @@index([influencer_id])
  @@index([visit_date])
  @@schema("influencer")
}

model tier_support_policies {
  id                    Int            @id @default(autoincrement())
  tier                  InfluencerTier @unique
  max_support_per_visit Decimal        @db.Decimal(12, 2)
  max_support_per_month Decimal        @db.Decimal(12, 2)
  max_visits_per_month  Int            @default(1)
  support_rate_percent  Int
  allowed_categories    Json?
  excluded_procedures   Json?
  additional_benefits   Json?
  is_active             Boolean        @default(true)
  created_at            DateTime       @default(now())
  updated_at            DateTime       @updatedAt

  @@schema("influencer")
}

// ==================== ENUMS ====================

enum ManualStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@schema("manual")
}

enum CostType {
  LABOR
  RENT
  MATERIAL
  EQUIPMENT
  OTHER

  @@schema("business")
}

enum InfluencerTier {
  SS
  S
  A
  B
  C

  @@schema("influencer")
}

enum SupportStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW

  @@schema("influencer")
}
