generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model audit_logs {
  id          Int      @id @default(autoincrement())
  user_id     String?
  action      String
  entity_type String
  entity_id   Int?
  detail      Json?
  created_at  DateTime @default(now())
  users       users?   @relation(fields: [user_id], references: [id])
}

model brands {
  id               Int      @id @default(autoincrement())
  name             String   @unique
  name_en          String?
  manufacturer     String
  distributor      String?
  category         String
  official_url     String?
  product_page_url String?
  logo_url         String?
  description      String?
  is_active        Boolean  @default(true)
  created_at       DateTime @default(now())
  updated_at       DateTime
}

model company_settings {
  id                Int      @id @default(autoincrement())
  name              String
  business_number   String?
  representative    String?
  address           String?
  phone             String?
  fax               String?
  email             String?
  business_type     String?
  business_category String?
  created_at        DateTime @default(now())
  updated_at        DateTime
}

model contacts {
  id         Int      @id @default(autoincrement())
  partner_id Int
  name       String
  department String?
  position   String?
  phone      String?
  mobile     String?
  email      String?
  is_primary Boolean  @default(false)
  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime
  partners   partners @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  items      items[]
}

model invoice_hashes {
  id              Int       @id @default(autoincrement())
  hash            String    @unique
  partner_id      Int?
  invoice_date    DateTime? @db.Date
  total_amount    Decimal?  @db.Decimal(12, 2)
  item_count      Int
  raw_content     String?
  processed_at    DateTime  @default(now())
  transaction_ids String?
  partners        partners? @relation(fields: [partner_id], references: [id])
}

model item_barcodes {
  id            Int     @id @default(autoincrement())
  item_id       Int
  barcode_value String  @unique
  barcode_type  String?
  label         String?
  items         items   @relation(fields: [item_id], references: [id], onDelete: Cascade)
}

model item_lots {
  id                 Int                  @id @default(autoincrement())
  item_id            Int
  lot_number         String
  expiry_date        DateTime?            @db.Date
  initial_qty        Int
  current_qty        Int
  location_id        Int?
  created_at         DateTime             @default(now())
  items              items                @relation(fields: [item_id], references: [id], onDelete: Cascade)
  locations          locations?           @relation(fields: [location_id], references: [id])
  loan_items         loan_items[]
  stock_transactions stock_transactions[]

  @@unique([item_id, lot_number, location_id])
}

model item_matching_logs {
  id               Int      @id @default(autoincrement())
  partner_id       Int?
  input_name       String
  matched_item_id  Int?
  candidate_ids    Json?
  candidate_scores Json?
  match_method     String?
  confidence       Float?
  user_action      String?
  user_selection   Int?
  resolved         Boolean  @default(false)
  created_at       DateTime @default(now())

  @@index([partner_id])
  @@index([resolved])
}

model items {
  id                                                 Int                     @id @default(autoincrement())
  name                                               String
  category                                           String
  subcategory                                        String?
  brand                                              String?
  model                                              String?
  unit                                               String?
  storage_condition                                  String?
  description                                        String?
  image_url                                          String?
  created_at                                         DateTime                @default(now())
  updated_at                                         DateTime
  distributor                                        String?
  manufacturer                                       String?
  brand_en                                           String?
  category_en                                        String?
  distributor_en                                     String?
  manufacturer_en                                    String?
  name_en                                            String?
  subcategory_en                                     String?
  order_contact_name                                 String?
  order_contact_phone                                String?
  order_login_id                                     String?
  order_login_pw                                     String?
  order_method                                       String?
  order_website                                      String?
  usage_manual                                       String?
  aliases                                            Json?
  accessories                                        Json?
  packaging_desc                                     String?
  total_volume                                       Float?
  unit_type                                          String?
  unit_volume                                        Float?
  unit_volume_unit                                   String?
  units_per_box                                      Int?
  boxes_per_carton                                   Int?
  order_contact_id                                   Int?
  needs_order                                        Boolean?                @default(false)
  default_in_location_id                             Int?
  default_out_location_id                            Int?
  min_stock                                          Int?
  item_barcodes                                      item_barcodes[]
  item_lots                                          item_lots[]
  locations_items_default_in_location_idTolocations  locations?              @relation("items_default_in_location_idTolocations", fields: [default_in_location_id], references: [id])
  locations_items_default_out_location_idTolocations locations?              @relation("items_default_out_location_idTolocations", fields: [default_out_location_id], references: [id])
  contacts                                           contacts?               @relation(fields: [order_contact_id], references: [id])
  loan_items                                         loan_items[]
  partner_item_mappings                              partner_item_mappings[]
  stock_transactions                                 stock_transactions[]
}

model loan_items {
  id        Int        @id @default(autoincrement())
  loan_id   Int
  item_id   Int
  qty       Int
  lot_id    Int?
  items     items      @relation(fields: [item_id], references: [id], onDelete: Cascade)
  loans     loans      @relation(fields: [loan_id], references: [id], onDelete: Cascade)
  item_lots item_lots? @relation(fields: [lot_id], references: [id])
}

model loans {
  id              Int           @id @default(autoincrement())
  partner_id      Int
  direction       LoanDirection
  status          LoanStatus    @default(ONGOING)
  start_date      DateTime      @db.Date
  expected_return DateTime?     @db.Date
  actual_return   DateTime?     @db.Date
  note            String?
  created_at      DateTime      @default(now())
  loan_items      loan_items[]
  partners        partners      @relation(fields: [partner_id], references: [id], onDelete: Cascade)
}

model locations {
  id                                                                Int                  @id @default(autoincrement())
  code                                                              String               @unique
  name                                                              String
  type                                                              String
  parent_id                                                         Int?
  qr_value                                                          String
  is_active                                                         Boolean              @default(true)
  created_at                                                        DateTime             @default(now())
  item_lots                                                         item_lots[]
  items_items_default_in_location_idTolocations                     items[]              @relation("items_default_in_location_idTolocations")
  items_items_default_out_location_idTolocations                    items[]              @relation("items_default_out_location_idTolocations")
  locations                                                         locations?           @relation("locationsTolocations", fields: [parent_id], references: [id])
  other_locations                                                   locations[]          @relation("locationsTolocations")
  stock_transactions_stock_transactions_from_location_idTolocations stock_transactions[] @relation("stock_transactions_from_location_idTolocations")
  stock_transactions_stock_transactions_to_location_idTolocations   stock_transactions[] @relation("stock_transactions_to_location_idTolocations")
}

model partner_item_mappings {
  id                Int      @id @default(autoincrement())
  partner_id        Int
  item_id           Int
  partner_item_name String
  partner_item_code String?
  usage_count       Int      @default(1)
  confidence        Float    @default(1.0)
  source            String   @default("manual")
  created_at        DateTime @default(now())
  updated_at        DateTime
  items             items    @relation(fields: [item_id], references: [id], onDelete: Cascade)
  partners          partners @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@unique([partner_id, partner_item_name])
  @@index([partner_id])
}

model partners {
  id                    Int                     @id @default(autoincrement())
  name                  String
  business_number       String?
  representative        String?
  address               String?
  phone                 String?
  type                  String?
  created_at            DateTime                @default(now())
  invoice_config        Json?
  invoice_history       Json?
  updated_at            DateTime                @default(now())
  contacts              contacts[]
  invoice_hashes        invoice_hashes[]
  loans                 loans[]
  partner_item_mappings partner_item_mappings[]
  stock_transactions    stock_transactions[]
}

model roles {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  users       users[]
}

model stock_transactions {
  id                                                       Int         @id @default(autoincrement())
  item_id                                                  Int
  lot_id                                                   Int?
  type                                                     StockTxType
  qty                                                      Int
  from_location_id                                         Int?
  to_location_id                                           Int?
  performed_by                                             String?
  partner_id                                               Int?
  note                                                     String?
  created_at                                               DateTime    @default(now())
  locations_stock_transactions_from_location_idTolocations locations?  @relation("stock_transactions_from_location_idTolocations", fields: [from_location_id], references: [id])
  items                                                    items       @relation(fields: [item_id], references: [id], onDelete: Cascade)
  item_lots                                                item_lots?  @relation(fields: [lot_id], references: [id])
  partners                                                 partners?   @relation(fields: [partner_id], references: [id])
  users                                                    users?      @relation(fields: [performed_by], references: [id])
  locations_stock_transactions_to_location_idTolocations   locations?  @relation("stock_transactions_to_location_idTolocations", fields: [to_location_id], references: [id])
}

model users {
  id                 String               @id
  email              String               @unique
  name               String
  role_id            Int?
  created_at         DateTime             @default(now())
  audit_logs         audit_logs[]
  stock_transactions stock_transactions[]
  roles              roles?               @relation(fields: [role_id], references: [id])
}

enum LoanDirection {
  OUT
  IN
}

enum LoanStatus {
  ONGOING
  RETURNED
  OVERDUE
}

enum StockTxType {
  IN
  OUT
  ADJUST
  LOAN_OUT
  LOAN_IN
  TRANSFER
}

// ============================================
// 매뉴얼 관리 테이블 (Manual Management)
// ============================================

// 매뉴얼 카테고리
model manual_categories {
  id          Int                 @id @default(autoincrement())
  name        String
  description String?
  parent_id   Int?
  parent      manual_categories?  @relation("ManualCategoryHierarchy", fields: [parent_id], references: [id])
  children    manual_categories[] @relation("ManualCategoryHierarchy")
  manuals     manuals[]
  order       Int                 @default(0)
  created_at  DateTime            @default(now())
  updated_at  DateTime            @updatedAt
}

// 매뉴얼
model manuals {
  id          Int                @id @default(autoincrement())
  title       String
  content     String             @db.Text
  summary     String?            @db.Text
  category_id Int?
  category    manual_categories? @relation(fields: [category_id], references: [id])
  tags        manual_tags[]
  versions    manual_versions[]
  attachments manual_attachments[]
  status      ManualStatus       @default(DRAFT)
  version     Int                @default(1)
  view_count  Int                @default(0)
  created_by  String?
  updated_by  String?
  created_at  DateTime           @default(now())
  updated_at  DateTime           @updatedAt

  @@index([category_id])
  @@index([status])
}

enum ManualStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// 매뉴얼 버전 히스토리
model manual_versions {
  id          Int      @id @default(autoincrement())
  manual_id   Int
  manual      manuals  @relation(fields: [manual_id], references: [id], onDelete: Cascade)
  title       String
  content     String   @db.Text
  version     Int
  changed_by  String?
  change_note String?
  created_at  DateTime @default(now())

  @@index([manual_id])
}

// 태그
model manual_tags {
  id      Int       @id @default(autoincrement())
  name    String    @unique
  manuals manuals[]
}

// 첨부파일
model manual_attachments {
  id         Int      @id @default(autoincrement())
  manual_id  Int
  manual     manuals  @relation(fields: [manual_id], references: [id], onDelete: Cascade)
  file_name  String
  file_url   String
  file_size  Int?
  mime_type  String?
  created_at DateTime @default(now())

  @@index([manual_id])
}
