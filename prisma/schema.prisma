generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model audit_logs {
  id          Int      @id @default(autoincrement())
  user_id     String?
  action      String
  entity_type String
  entity_id   Int?
  detail      Json?
  created_at  DateTime @default(now())
  users       users?   @relation(fields: [user_id], references: [id])
}

model brands {
  id               Int      @id @default(autoincrement())
  name             String   @unique
  name_en          String?
  manufacturer     String
  distributor      String?
  category         String
  official_url     String?
  product_page_url String?
  logo_url         String?
  description      String?
  is_active        Boolean  @default(true)
  created_at       DateTime @default(now())
  updated_at       DateTime
}

model company_settings {
  id                Int      @id @default(autoincrement())
  name              String
  business_number   String?
  representative    String?
  address           String?
  phone             String?
  fax               String?
  email             String?
  business_type     String?
  business_category String?
  created_at        DateTime @default(now())
  updated_at        DateTime
}

model contacts {
  id         Int      @id @default(autoincrement())
  partner_id Int
  name       String
  department String?
  position   String?
  phone      String?
  mobile     String?
  email      String?
  is_primary Boolean  @default(false)
  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime
  partners   partners @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  items      items[]
}

model invoice_hashes {
  id              Int       @id @default(autoincrement())
  hash            String    @unique
  partner_id      Int?
  invoice_date    DateTime? @db.Date
  total_amount    Decimal?  @db.Decimal(12, 2)
  item_count      Int
  raw_content     String?
  processed_at    DateTime  @default(now())
  transaction_ids String?
  partners        partners? @relation(fields: [partner_id], references: [id])
}

model item_barcodes {
  id            Int     @id @default(autoincrement())
  item_id       Int
  barcode_value String  @unique
  barcode_type  String?
  label         String?
  items         items   @relation(fields: [item_id], references: [id], onDelete: Cascade)
}

model item_lots {
  id                 Int                  @id @default(autoincrement())
  item_id            Int
  lot_number         String
  expiry_date        DateTime?            @db.Date
  initial_qty        Int
  current_qty        Int
  location_id        Int?
  created_at         DateTime             @default(now())
  items              items                @relation(fields: [item_id], references: [id], onDelete: Cascade)
  locations          locations?           @relation(fields: [location_id], references: [id])
  loan_items         loan_items[]
  stock_transactions stock_transactions[]

  @@unique([item_id, lot_number, location_id])
}

model item_matching_logs {
  id               Int      @id @default(autoincrement())
  partner_id       Int?
  input_name       String
  matched_item_id  Int?
  candidate_ids    Json?
  candidate_scores Json?
  match_method     String?
  confidence       Float?
  user_action      String?
  user_selection   Int?
  resolved         Boolean  @default(false)
  created_at       DateTime @default(now())

  @@index([partner_id])
  @@index([resolved])
}

model items {
  id                                                 Int                     @id @default(autoincrement())
  name                                               String
  category                                           String
  subcategory                                        String?
  brand                                              String?
  model                                              String?
  unit                                               String?
  storage_condition                                  String?
  description                                        String?
  image_url                                          String?
  created_at                                         DateTime                @default(now())
  updated_at                                         DateTime
  distributor                                        String?
  manufacturer                                       String?
  brand_en                                           String?
  category_en                                        String?
  distributor_en                                     String?
  manufacturer_en                                    String?
  name_en                                            String?
  subcategory_en                                     String?
  order_contact_name                                 String?
  order_contact_phone                                String?
  order_login_id                                     String?
  order_login_pw                                     String?
  order_method                                       String?
  order_website                                      String?
  usage_manual                                       String?
  aliases                                            Json?
  accessories                                        Json?
  packaging_desc                                     String?
  total_volume                                       Float?
  unit_type                                          String?
  unit_volume                                        Float?
  unit_volume_unit                                   String?
  units_per_box                                      Int?
  boxes_per_carton                                   Int?
  order_contact_id                                   Int?
  needs_order                                        Boolean?                @default(false)
  default_in_location_id                             Int?
  default_out_location_id                            Int?
  min_stock                                          Int?
  item_barcodes                                      item_barcodes[]
  item_lots                                          item_lots[]
  locations_items_default_in_location_idTolocations  locations?              @relation("items_default_in_location_idTolocations", fields: [default_in_location_id], references: [id])
  locations_items_default_out_location_idTolocations locations?              @relation("items_default_out_location_idTolocations", fields: [default_out_location_id], references: [id])
  contacts                                           contacts?               @relation(fields: [order_contact_id], references: [id])
  loan_items                                         loan_items[]
  partner_item_mappings                              partner_item_mappings[]
  stock_transactions                                 stock_transactions[]
  procedure_items                                    procedure_items[]
}

model loan_items {
  id        Int        @id @default(autoincrement())
  loan_id   Int
  item_id   Int
  qty       Int
  lot_id    Int?
  items     items      @relation(fields: [item_id], references: [id], onDelete: Cascade)
  loans     loans      @relation(fields: [loan_id], references: [id], onDelete: Cascade)
  item_lots item_lots? @relation(fields: [lot_id], references: [id])
}

model loans {
  id              Int           @id @default(autoincrement())
  partner_id      Int
  direction       LoanDirection
  status          LoanStatus    @default(ONGOING)
  start_date      DateTime      @db.Date
  expected_return DateTime?     @db.Date
  actual_return   DateTime?     @db.Date
  note            String?
  created_at      DateTime      @default(now())
  loan_items      loan_items[]
  partners        partners      @relation(fields: [partner_id], references: [id], onDelete: Cascade)
}

model locations {
  id                                                                Int                  @id @default(autoincrement())
  code                                                              String               @unique
  name                                                              String
  type                                                              String
  parent_id                                                         Int?
  qr_value                                                          String
  is_active                                                         Boolean              @default(true)
  created_at                                                        DateTime             @default(now())
  item_lots                                                         item_lots[]
  items_items_default_in_location_idTolocations                     items[]              @relation("items_default_in_location_idTolocations")
  items_items_default_out_location_idTolocations                    items[]              @relation("items_default_out_location_idTolocations")
  locations                                                         locations?           @relation("locationsTolocations", fields: [parent_id], references: [id])
  other_locations                                                   locations[]          @relation("locationsTolocations")
  stock_transactions_stock_transactions_from_location_idTolocations stock_transactions[] @relation("stock_transactions_from_location_idTolocations")
  stock_transactions_stock_transactions_to_location_idTolocations   stock_transactions[] @relation("stock_transactions_to_location_idTolocations")
}

model partner_item_mappings {
  id                Int      @id @default(autoincrement())
  partner_id        Int
  item_id           Int
  partner_item_name String
  partner_item_code String?
  usage_count       Int      @default(1)
  confidence        Float    @default(1.0)
  source            String   @default("manual")
  created_at        DateTime @default(now())
  updated_at        DateTime
  items             items    @relation(fields: [item_id], references: [id], onDelete: Cascade)
  partners          partners @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@unique([partner_id, partner_item_name])
  @@index([partner_id])
}

model partners {
  id                    Int                     @id @default(autoincrement())
  name                  String
  business_number       String?
  representative        String?
  address               String?
  phone                 String?
  type                  String?
  created_at            DateTime                @default(now())
  invoice_config        Json?
  invoice_history       Json?
  updated_at            DateTime                @default(now())
  contacts              contacts[]
  invoice_hashes        invoice_hashes[]
  loans                 loans[]
  partner_item_mappings partner_item_mappings[]
  stock_transactions    stock_transactions[]
}

model roles {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  users       users[]
}

model stock_transactions {
  id                                                       Int         @id @default(autoincrement())
  item_id                                                  Int
  lot_id                                                   Int?
  type                                                     StockTxType
  qty                                                      Int
  from_location_id                                         Int?
  to_location_id                                           Int?
  performed_by                                             String?
  partner_id                                               Int?
  note                                                     String?
  created_at                                               DateTime    @default(now())
  locations_stock_transactions_from_location_idTolocations locations?  @relation("stock_transactions_from_location_idTolocations", fields: [from_location_id], references: [id])
  items                                                    items       @relation(fields: [item_id], references: [id], onDelete: Cascade)
  item_lots                                                item_lots?  @relation(fields: [lot_id], references: [id])
  partners                                                 partners?   @relation(fields: [partner_id], references: [id])
  users                                                    users?      @relation(fields: [performed_by], references: [id])
  locations_stock_transactions_to_location_idTolocations   locations?  @relation("stock_transactions_to_location_idTolocations", fields: [to_location_id], references: [id])
}

model users {
  id                 String               @id
  email              String               @unique
  name               String
  role_id            Int?
  created_at         DateTime             @default(now())
  audit_logs         audit_logs[]
  stock_transactions stock_transactions[]
  roles              roles?               @relation(fields: [role_id], references: [id])
}

enum LoanDirection {
  OUT
  IN
}

enum LoanStatus {
  ONGOING
  RETURNED
  OVERDUE
}

enum StockTxType {
  IN
  OUT
  ADJUST
  LOAN_OUT
  LOAN_IN
  TRANSFER
}

// ============================================
// 매뉴얼 관리 테이블 (Manual Management)
// ============================================

// 매뉴얼 카테고리
model manual_categories {
  id          Int                 @id @default(autoincrement())
  name        String
  description String?
  parent_id   Int?
  parent      manual_categories?  @relation("ManualCategoryHierarchy", fields: [parent_id], references: [id])
  children    manual_categories[] @relation("ManualCategoryHierarchy")
  manuals     manuals[]
  order       Int                 @default(0)
  created_at  DateTime            @default(now())
  updated_at  DateTime            @updatedAt
}

// 매뉴얼
model manuals {
  id          Int                  @id @default(autoincrement())
  title       String
  content     String               @db.Text
  summary     String?              @db.Text
  category_id Int?
  category    manual_categories?   @relation(fields: [category_id], references: [id])
  tags        manual_tags[]
  versions    manual_versions[]
  attachments manual_attachments[]
  embedding   manual_embeddings?
  chunks      manual_chunks[]
  procedure_links procedure_manuals[]
  status      ManualStatus         @default(DRAFT)
  version     Int                  @default(1)
  view_count  Int                  @default(0)
  created_by  String?
  updated_by  String?
  created_at  DateTime             @default(now())
  updated_at  DateTime             @updatedAt

  @@index([category_id])
  @@index([status])
}

enum ManualStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// 매뉴얼 버전 히스토리
model manual_versions {
  id          Int      @id @default(autoincrement())
  manual_id   Int
  manual      manuals  @relation(fields: [manual_id], references: [id], onDelete: Cascade)
  title       String
  content     String   @db.Text
  version     Int
  changed_by  String?
  change_note String?
  created_at  DateTime @default(now())

  @@index([manual_id])
}

// 태그
model manual_tags {
  id      Int       @id @default(autoincrement())
  name    String    @unique
  manuals manuals[]
}

// 첨부파일
model manual_attachments {
  id         Int      @id @default(autoincrement())
  manual_id  Int
  manual     manuals  @relation(fields: [manual_id], references: [id], onDelete: Cascade)
  file_name  String
  file_url   String
  file_size  Int?
  mime_type  String?
  created_at DateTime @default(now())

  @@index([manual_id])
}

// 매뉴얼 임베딩 (벡터 검색용)
model manual_embeddings {
  id               Int                        @id @default(autoincrement())
  manual_id        Int                        @unique
  manual           manuals                    @relation(fields: [manual_id], references: [id], onDelete: Cascade)
  embedding        Bytes                      // Float32 배열 직렬화 (레거시)
  embedding_vector Unsupported("vector(768)") // pgvector 네이티브 벡터 타입
  content_hash     String                     // 변경 감지용
  created_at       DateTime                   @default(now())
  updated_at       DateTime                   @updatedAt
}

// 매뉴얼 청크 (긴 문서 분할, 벡터 검색용)
model manual_chunks {
  id               Int                        @id @default(autoincrement())
  manual_id        Int
  manual           manuals                    @relation(fields: [manual_id], references: [id], onDelete: Cascade)
  chunk_index      Int                        // 문서 내 청크 순서
  content          String                     @db.Text
  section_title    String?                    // 섹션 제목
  start_offset     Int                        // 원본 문서에서 시작 위치
  end_offset       Int                        // 원본 문서에서 끝 위치
  token_count      Int                        // 청크 토큰 수
  content_hash     String                     // 변경 감지용
  embedding        Bytes                      // Float32 배열 직렬화 (호환성용)
  embedding_vector Unsupported("vector(768)") // pgvector 네이티브 벡터 타입
  created_at       DateTime                   @default(now())
  updated_at       DateTime                   @updatedAt

  @@index([manual_id])
  @@index([content_hash])
  @@unique([manual_id, chunk_index])
}

// AI 채팅 세션
model ai_chat_sessions {
  id         Int      @id @default(autoincrement())
  title      String?
  messages   Json     // [{role, content, timestamp}]
  context    Json?    // 참조된 매뉴얼 ID들
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// ============================================
// 비즈니스 인텔리전스 시스템 (Business Intelligence)
// ============================================

// 시술/서비스 정의
model procedures {
  id                Int                    @id @default(autoincrement())
  name              String                 // 시술명 (예: 울쎄라)
  name_en           String?                // 영문명
  category          String                 // 카테고리 (안티에이징, 쁘띠성형 등)
  subcategory       String?                // 세부 카테고리
  description       String?                @db.Text

  // 시간 관련
  duration_minutes  Int                    // 기본 소요시간 (분)
  buffer_minutes    Int                    @default(10)  // 시술 간 버퍼 시간

  // 원가 구성
  base_cost         Decimal                @db.Decimal(12, 2)  // 기본 원가

  // 상태
  is_active         Boolean                @default(true)
  requires_doctor   Boolean                @default(true)  // 의사 필수 여부

  // 연관 관계
  cost_components   procedure_costs[]
  required_items    procedure_items[]
  required_equipment procedure_equipment[]
  manual_links      procedure_manuals[]
  influencer_supports influencer_procedure_supports[]

  created_at        DateTime               @default(now())
  updated_at        DateTime               @updatedAt

  @@index([category])
  @@index([is_active])
}

// 시술 원가 구성요소
model procedure_costs {
  id              Int        @id @default(autoincrement())
  procedure_id    Int
  procedure       procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)

  cost_type       CostType   // LABOR, RENT, MATERIAL, EQUIPMENT, OTHER
  name            String     // 비용 항목명
  amount          Decimal    @db.Decimal(12, 2)
  unit            String?    // 단위 (시간당, 회당 등)
  calculation     String?    // 계산 방식 설명

  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  @@index([procedure_id])
}

enum CostType {
  LABOR       // 인건비 (의사, 간호사, 어시스턴트)
  RENT        // 임대비 (시간당 룸 비용)
  MATERIAL    // 재료비 (일회용품, 약품 등)
  EQUIPMENT   // 장비비 (감가상각)
  OTHER       // 기타
}

// 시술에 필요한 재료 (items 테이블과 연결)
model procedure_items {
  id            Int        @id @default(autoincrement())
  procedure_id  Int
  procedure     procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)
  item_id       Int
  item          items      @relation(fields: [item_id], references: [id])

  quantity      Decimal    @db.Decimal(10, 4)  // 사용량
  unit          String     // 단위
  is_optional   Boolean    @default(false)

  @@unique([procedure_id, item_id])
}

// 시술에 필요한 장비
model procedure_equipment {
  id            Int        @id @default(autoincrement())
  procedure_id  Int
  procedure     procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)

  equipment_name String    // 장비명
  usage_minutes  Int?      // 사용 시간

  @@index([procedure_id])
}

// 시술-매뉴얼 연결
model procedure_manuals {
  id            Int        @id @default(autoincrement())
  procedure_id  Int
  procedure     procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)
  manual_id     Int
  manual        manuals    @relation(fields: [manual_id], references: [id], onDelete: Cascade)

  relation_type String     // GUIDE, PROTOCOL, FAQ, AFTERCARE 등

  @@unique([procedure_id, manual_id])
}

// 인플루언서 기본 정보
model influencers {
  id                Int                      @id @default(autoincrement())
  name              String
  nickname          String?                  // SNS 활동명
  email             String?
  phone             String?

  // 소셜 미디어
  instagram_handle  String?
  youtube_channel   String?
  tiktok_handle     String?
  blog_url          String?

  // AI 분석 결과
  current_tier      InfluencerTier           @default(C)
  tier_score        Decimal?                 @db.Decimal(5, 2)  // 0-100점
  last_analyzed_at  DateTime?

  // 협업 히스토리
  total_visits      Int                      @default(0)
  total_supported   Decimal                  @default(0) @db.Decimal(12, 2)

  // 메모
  notes             String?                  @db.Text

  // 상태
  is_active         Boolean                  @default(true)
  is_blacklisted    Boolean                  @default(false)
  blacklist_reason  String?

  // 연관
  analyses          influencer_analyses[]
  supports          influencer_procedure_supports[]
  visits            influencer_visits[]

  created_at        DateTime                 @default(now())
  updated_at        DateTime                 @updatedAt

  @@index([current_tier])
  @@index([is_active])
}

enum InfluencerTier {
  SS    // 최상위 (100만+ 팔로워, 높은 영향력)
  S     // 상위 (50만-100만)
  A     // 중상위 (10만-50만)
  B     // 중위 (1만-10만)
  C     // 마이크로 (1만 미만)
}

// AI 분석 히스토리
model influencer_analyses {
  id              Int          @id @default(autoincrement())
  influencer_id   Int
  influencer      influencers  @relation(fields: [influencer_id], references: [id], onDelete: Cascade)

  // SNS 메트릭
  instagram_followers   Int?
  instagram_engagement  Decimal?   @db.Decimal(5, 2)  // 참여율 %
  youtube_subscribers   Int?
  youtube_avg_views     Int?
  tiktok_followers      Int?
  tiktok_engagement     Decimal?   @db.Decimal(5, 2)

  // AI 분석 결과
  calculated_tier       InfluencerTier
  tier_score            Decimal    @db.Decimal(5, 2)

  // 분석 상세
  analysis_summary      String?    @db.Text           // AI가 생성한 요약
  analysis_raw          Json?                          // 전체 분석 데이터

  // 권장 지원 범위
  recommended_support_min Decimal? @db.Decimal(12, 2)
  recommended_support_max Decimal? @db.Decimal(12, 2)

  analyzed_at           DateTime   @default(now())

  @@index([influencer_id])
  @@index([analyzed_at])
}

// 인플루언서 시술 지원 기록
model influencer_procedure_supports {
  id              Int          @id @default(autoincrement())
  influencer_id   Int
  influencer      influencers  @relation(fields: [influencer_id], references: [id], onDelete: Cascade)
  procedure_id    Int
  procedure       procedures   @relation(fields: [procedure_id], references: [id])
  visit_id        Int?
  visit           influencer_visits? @relation(fields: [visit_id], references: [id])

  // 비용 정보
  procedure_cost  Decimal      @db.Decimal(12, 2)  // 시술 원가
  supported_amount Decimal     @db.Decimal(12, 2)  // 지원 금액
  client_payment  Decimal      @db.Decimal(12, 2)  // 본인 부담금

  // 상태
  status          SupportStatus @default(SCHEDULED)

  scheduled_at    DateTime?
  completed_at    DateTime?

  notes           String?

  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  @@index([influencer_id])
  @@index([procedure_id])
  @@index([status])
}

enum SupportStatus {
  SCHEDULED   // 예정
  COMPLETED   // 완료
  CANCELLED   // 취소
  NO_SHOW     // 노쇼
}

// 인플루언서 방문 기록
model influencer_visits {
  id              Int          @id @default(autoincrement())
  influencer_id   Int
  influencer      influencers  @relation(fields: [influencer_id], references: [id], onDelete: Cascade)

  visit_date      DateTime
  purpose         String?      // 방문 목적

  // 결과
  content_posted  Boolean      @default(false)  // 콘텐츠 게시 여부
  content_urls    Json?        // 게시된 콘텐츠 URL들

  // 지원 시술들
  supports        influencer_procedure_supports[]

  notes           String?

  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  @@index([influencer_id])
  @@index([visit_date])
}

// 등급별 지원 정책
model tier_support_policies {
  id              Int            @id @default(autoincrement())
  tier            InfluencerTier @unique

  // 지원 한도
  max_support_per_visit   Decimal   @db.Decimal(12, 2)  // 방문당 최대 지원액
  max_support_per_month   Decimal   @db.Decimal(12, 2)  // 월 최대 지원액
  max_visits_per_month    Int       @default(1)          // 월 최대 방문 횟수

  // 지원율
  support_rate_percent    Int       // 시술 원가 대비 지원율 (%)

  // 지원 가능 시술 카테고리
  allowed_categories      Json?     // ["안티에이징", "스킨부스터"]
  excluded_procedures     Json?     // 제외 시술 ID 목록

  // 추가 혜택
  additional_benefits     Json?     // 기타 혜택 정보

  is_active               Boolean   @default(true)

  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt
}
